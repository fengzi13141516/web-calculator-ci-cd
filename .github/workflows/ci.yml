name: CI/CD Pipeline for Web Calculator

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run unit tests
      run: |
        python -m pytest tests/unit/ -v --cov=app --cov-report=xml
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: coverage.xml

  functional-test:
    name: Functional Tests
    runs-on: ubuntu-latest
    needs: unit-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run functional tests
      run: |
        # 启动Flask应用
        python app.py &
        APP_PID=$!
        
        # 等待应用启动
        sleep 5
        
        # 运行测试
        echo "测试健康检查..."
        curl -f "http://localhost:5000/health" || (echo "健康检查失败"; exit 1)
        
        echo "测试加法..."
        curl -f "http://localhost:5000/add/2&3" || (echo "加法测试失败"; exit 1)
        
        echo "测试乘法..."
        curl -f "http://localhost:5000/multiply/4&5" || (echo "乘法测试失败"; exit 1)
        
        echo "测试无效输入..."
        STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:5000/add/abc&xyz")
        if [ "$STATUS_CODE" -ne 400 ]; then
          echo "无效输入测试失败，期望400，得到$STATUS_CODE"
          exit 1
        fi
        
        echo "所有功能测试通过！"
        
        # 停止应用
        kill $APP_PID 2>/dev/null || true

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: functional-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Docker image
      run: |
        docker build -t web-calculator:${{ github.sha }} .
        docker tag web-calculator:${{ github.sha }} web-calculator:latest
        
        echo "镜像构建成功！"
        docker images
        
    - name: Push to GitHub Container Registry (可选)
      if: false  # 默认关闭，需要时开启
      run: |
        # 需要设置GITHUB_TOKEN权限
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        docker tag web-calculator:${{ github.sha }} ghcr.io/${{ github.repository }}:${{ github.sha }}
        docker tag web-calculator:${{ github.sha }} ghcr.io/${{ github.repository }}:latest
        docker push ghcr.io/${{ github.repository }}:${{ github.sha }}
        docker push ghcr.io/${{ github.repository }}:latest

  # 部署阶段 - 蓝绿部署
  deploy:
    needs: [build-docker]  # 等待构建阶段完成
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
    
    - name: Copy deployment files to server
      run: |
        # 创建部署目录
        ssh -o StrictHostKeyChecking=no -p ${{ secrets.DEPLOY_PORT }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "mkdir -p /opt/web-calculator/nginx"
        
        # 复制部署文件
        scp -o StrictHostKeyChecking=no -P ${{ secrets.DEPLOY_PORT }} -r deploy/* ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/opt/web-calculator/
        
        # 复制部署脚本
        scp -o StrictHostKeyChecking=no -P ${{ secrets.DEPLOY_PORT }} .github/workflows/deploy.sh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/opt/web-calculator/
        
        # 设置权限
        ssh -o StrictHostKeyChecking=no -p ${{ secrets.DEPLOY_PORT }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "chmod +x /opt/web-calculator/deploy.sh"
    
    - name: Setup initial environment on server
      run: |
        ssh -o StrictHostKeyChecking=no -p ${{ secrets.DEPLOY_PORT }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          cd /opt/web-calculator
          
          # 创建.env文件（如果不存在）
          if [ ! -f .env ]; then
            echo "BLUE_IMAGE=ghcr.io/${{ github.repository_owner }}/web-calculator-ci-cd:latest" > .env
            echo "GREEN_IMAGE=ghcr.io/${{ github.repository_owner }}/web-calculator-ci-cd:latest" >> .env
          fi
          
          # 拉取并启动服务（首次部署）
          docker-compose pull || true
          docker-compose up -d --remove-orphans || true
        EOF
    
    - name: Execute blue-green deployment
      run: |
        # 构建完整的镜像名称
        IMAGE_NAME="ghcr.io/${{ github.repository }}:${{ github.sha }}"
        
        # 执行部署脚本
        ssh -o StrictHostKeyChecking=no -p ${{ secrets.DEPLOY_PORT }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "cd /opt/web-calculator && ./deploy.sh '$IMAGE_NAME'"
    
    - name: Verify deployment
      run: |
        # 等待服务就绪
        sleep 10
        
        # 验证部署
        curl -f http://${{ secrets.DEPLOY_HOST }}/health || exit 1
        echo "✅ 部署验证成功"
        
        # 测试计算功能
        curl -f http://${{ secrets.DEPLOY_HOST }}/add/2&3
        echo "✅ 计算功能正常"
    
    - name: Send deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ 部署成功!"
          echo "应用地址: http://${{ secrets.DEPLOY_HOST }}"
          echo "健康检查: http://${{ secrets.DEPLOY_HOST }}/health"
          echo "测试加法: http://${{ secrets.DEPLOY_HOST }}/add/2&3"
        else
          echo "❌ 部署失败!"
          echo "请检查GitHub Actions日志"
        fi
